#include <stdio.h>
#include <stdlib.h>

int main(void) {
	
	int s[5][5][64];
	int h[8][64], a[9][64], b[9][64], c[9][64], d[9][64], e[9][64];
	int i = 0, flag = 0;
	
	char filename[15];
	char ch;
	
	FILE *fptr;
	
	
	/******************************************************************/
	//Opening the file which contains the hash value.
	/******************************************************************/
		
		printf("Enter the name of the file containing the hash value : ");
		scanf("%s", filename);

		fptr = fopen(filename, "r");
		if (fptr == NULL)
		{
			printf("Cannot open file \n");
			exit(0);
		}

		ch = fgetc(fptr);
		while (ch != EOF)
		{
			if(i==512)
				break;
			h[i/64][i%64] = ch - '0';
			//printf("%d", h[i/64][i%64]);
			++i;
			ch = fgetc(fptr);
		}
		//printf("\n");
		fclose(fptr);
	
	/******************************************************************/
	//End of reading file containing the hash value
	/******************************************************************/
	
	
	
	/******************************************************************/
	//Opening the file which contains the preimage value.
	/******************************************************************/
	
		printf("Enter the name of the file containing the preimage value : ");
		scanf("%s", filename);

	

		fptr = fopen(filename, "r");
		if (fptr == NULL)
		{
			printf("Cannot open file \n");
			exit(0);
		}

		
		ch = fgetc(fptr);
		/******************************************************************/
		//Reading block D
		/******************************************************************/
		
			i = 0;
			while (i < 9*64)
			{
				d[i/64][i%64] = ch - '0';
				//printf("%d", d[i/64][i%64]);				
				++i;
				ch = fgetc(fptr);
				
			}
			//printf("\n");
			
		/******************************************************************/
		//End of reading block D
		/******************************************************************/
		
		
		/******************************************************************/
		//Reading block E
		/******************************************************************/

			i = 0;
			while (i < 9*64)
			{
				e[i/64][i%64] = ch - '0';
				//printf("%d", e[i/64][i%64]);
				++i;
				ch = fgetc(fptr);
			}
			//printf("\n");
		/******************************************************************/
		//End of reading block E
		/******************************************************************/


		fclose(fptr);
	
	/******************************************************************/
	//End of reading file containing the preimage value
	/******************************************************************/

	int p[9][64];
	int s1[5][5][64];
	int parity[5][64];
	
	for (int i = 0; i < 5; i++)
	{
		for (int j = 0; j < 5; j++)
		{
			for (int k = 0; k < 64; k++)
			{
				s[i][j][k]=0;
			}
		}
	}



	/******************************************************************/
	//Since there are five message block, there five KECCAK permutations
	/******************************************************************/

	for (int i = 3; i < 5; i++)
	{
	
		/******************************************************************/
		//XORing with the respective message block
		/******************************************************************/
		if (i==0)
			{
				for (int j = 0; j < 9; j++) 
					{
						for (int k = 0; k < 64; k++)
						{
							if(j<5)
								s[j][0][k]=(s[j][0][k]+a[j][k])%2;
							else
								s[j-5][1][k]=(s[j-5][1][k]+a[j][k])%2;
						}
					}
			}
		else if (i==1)
			{
				for (int j = 0; j < 9; j++) 
					{
						for (int k = 0; k < 64; k++)
						{
							if(j<5)
								s[j][0][k]=(s[j][0][k]+b[j][k])%2;
							else
								s[j-5][1][k]=(s[j-5][1][k]+b[j][k])%2;
						}
					}
			}
		else if (i==2)
			{
				for (int j = 0; j < 9; j++) 
					{
						for (int k = 0; k < 64; k++)
						{
							if(j<5)
								s[j][0][k]=(s[j][0][k]+c[j][k])%2;
							else
								s[j-5][1][k]=(s[j-5][1][k]+c[j][k])%2;
						}
					}
			}
		else if (i==3)
			{
				for (int j = 0; j < 9; j++) 
					{
						for (int k = 0; k < 64; k++)
						{
							if(j<5)
								s[j][0][k]=(s[j][0][k]+d[j][k])%2;
							else
								s[j-5][1][k]=(s[j-5][1][k]+d[j][k])%2;
						}
					}
			}
		else if (i==4)
			{
				for (int j = 0; j < 9; j++) 
					{
						for (int k = 0; k < 64; k++)
						{
							if(j<5)
								s[j][0][k]=(s[j][0][k]+e[j][k])%2;
							else
								s[j-5][1][k]=(s[j-5][1][k]+e[j][k])%2;
						}
					}
			}
		/******************************************************************/
		//End of XOR		
		/******************************************************************/


		/******************************************************************/
		//Theta function
		/******************************************************************/
		for (int j = 0; j < 5; ++j)
		{
			for (int k = 0; k < 64; k++)
			{
				parity[j][k]=(s[j][0][k]+s[j][1][k]+s[j][2][k]+s[j][3][k]+s[j][4][k])%2;
				
			}
		}
		
		
		for (int j = 0; j < 5; j++) //theta step mapping 
		{
				for (int l = 0; l < 64; l++)
				{
					int a1=(j+4)%5;
					int a2=(j+1)%5;
					int a3=(l+63)%64;
					int a4=(parity[a1][l]+parity[a2][a3])%2;
					
					s[j][0][l]=(s[j][0][l]+a4)%2;
					s[j][1][l]=(s[j][1][l]+a4)%2;
					s[j][2][l]=(s[j][2][l]+a4)%2;
					s[j][3][l]=(s[j][3][l]+a4)%2;
					s[j][4][l]=(s[j][4][l]+a4)%2;
				}
		}
		/******************************************************************/
		//End of Theta function
		/******************************************************************/

		
		
		/******************************************************************/
		//Rho function
		/******************************************************************/
		
		
		for (int l = 0; l < 64; l++)
		{
			s1[0][0][l]=s[0][0][l];
			s1[0][1][l]=s[0][1][(l+36)%64];
			s1[0][2][l]=s[0][2][(l+3)%64];
			s1[0][3][l]=s[0][3][(l+41)%64];
			s1[0][4][l]=s[0][4][(l+18)%64];
			s1[1][0][l]=s[1][0][(l+1)%64];
			s1[1][1][l]=s[1][1][(l+44)%64];
			s1[1][2][l]=s[1][2][(l+10)%64];
			s1[1][3][l]=s[1][3][(l+45)%64];
			s1[1][4][l]=s[1][4][(l+2)%64];
			s1[2][0][l]=s[2][0][(l+62)%64];
			s1[2][1][l]=s[2][1][(l+6)%64];
			s1[2][2][l]=s[2][2][(l+43)%64];
			s1[2][3][l]=s[2][3][(l+15)%64];
			s1[2][4][l]=s[2][4][(l+61)%64];
			s1[3][0][l]=s[3][0][(l+28)%64];
			s1[3][1][l]=s[3][1][(l+55)%64];
			s1[3][2][l]=s[3][2][(l+25)%64];
			s1[3][3][l]=s[3][3][(l+21)%64];
			s1[3][4][l]=s[3][4][(l+56)%64];
			s1[4][0][l]=s[4][0][(l+27)%64];
			s1[4][1][l]=s[4][1][(l+20)%64];
			s1[4][2][l]=s[4][2][(l+39)%64];
			s1[4][3][l]=s[4][3][(l+8)%64];
			s1[4][4][l]=s[4][4][(l+14)%64];	
		}

		/******************************************************************/
		//End of Rho function
		/******************************************************************/
		
		
		/******************************************************************/
		//Pi function
		/******************************************************************/
			
		for (int l = 0; l < 64; l++) 
		{
			s[0][0][l]=s1[0][0][l];
			s[1][0][l]=s1[1][1][l];
			s[2][0][l]=s1[2][2][l];
			s[3][0][l]=s1[3][3][l];
			s[4][0][l]=s1[4][4][l];
			s[0][1][l]=s1[3][0][l];
			s[1][1][l]=s1[4][1][l];
			s[2][1][l]=s1[0][2][l];
			s[3][1][l]=s1[1][3][l];
			s[4][1][l]=s1[2][4][l];
			s[0][2][l]=s1[1][0][l];
			s[1][2][l]=s1[2][1][l];
			s[2][2][l]=s1[3][2][l];
			s[3][2][l]=s1[4][3][l];
			s[4][2][l]=s1[0][4][l];
			s[0][3][l]=s1[4][0][l];
			s[1][3][l]=s1[0][1][l];
			s[2][3][l]=s1[1][2][l];
			s[3][3][l]=s1[2][3][l];
			s[4][3][l]=s1[3][4][l];
			s[0][4][l]=s1[2][0][l];
			s[1][4][l]=s1[3][1][l];
			s[2][4][l]=s1[4][2][l];
			s[3][4][l]=s1[0][3][l];
			s[4][4][l]=s1[1][4][l];
		}
		
		/******************************************************************/
		//End of Pi function
		/******************************************************************/
		
		
		/******************************************************************/
		//Chi function
		/******************************************************************/

		for (int k = 0; k < 5; k++) 
		{
			for (int l = 0; l < 64; l++)
			{
				int x0=s[0][k][l];
				int x1=s[1][k][l];
				int x2=s[2][k][l];
				int x3=s[3][k][l];
				int x4=s[4][k][l];
				s[0][k][l]=(x0+((x1+1)%2)*x2)%2;
				s[1][k][l]=(x1+((x2+1)%2)*x3)%2;
				s[2][k][l]=(x2+((x3+1)%2)*x4)%2;
				s[3][k][l]=(x3+((x4+1)%2)*x0)%2;
				s[4][k][l]=(x4+((x0+1)%2)*x1)%2;		
			}
		}
		
		/******************************************************************/
		//End of Chi function
		/******************************************************************/
		
		
		/******************************************************************/
		//Iota function
		/******************************************************************/

		s[0][0][0]=(s[0][0][0]+1)%2;
		
		/******************************************************************/
		//End of Iota function
		/******************************************************************/
		
	}
	printf("\n");
/*
	for(i =0; i<8; ++i) {
		for(int j=0; j<64; ++j)
			printf("%d", s[i/5][i%5][j]);
	}

*/
	/******************************************************************/
	//Checking for error
	/******************************************************************/
	
	for(int i=0;i<64;i++)
	{
		if(s[0][0][i]!=h[0][i]){
			printf("%d position error for h0 \n",i);
			flag = 1;
		}
		if(s[1][0][i]!=h[1][i]){
			printf("%d position error for h1\n",i);
			flag = 1;
		}
		if(s[2][0][i]!=h[2][i]){
			printf("%d position error for h2\n",i);
			flag = 1;
		}
		if(s[3][0][i]!=h[3][i]){
			printf("%d position error for h3\n",i);
			flag = 1;
		}
		if(s[4][0][i]!=h[4][i]){
			printf("%d position error for h4\n",i);
			flag = 1;
		}
		if(s[0][1][i]!=h[5][i]){
			printf("%d position error for h5\n",i);
			flag = 1;
		}
		if(s[1][1][i]!=h[6][i]){
			printf("%d position error for h6\n",i);
			flag = 1;
		}
		if(s[2][1][i]!=h[7][i]){
			printf("%d position error for h7\n",i);
			flag = 1;
		}
	}
	
	if(flag == 0)
		printf("The preimage value is correct.\n");

	/******************************************************************/
	//End of error checking
	/******************************************************************/
	return 0;
}